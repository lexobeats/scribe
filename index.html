<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La roue du Scribe !</title>
  <style>
    :root {
      --wheel-radius: 260px;
      --accent-orange: #f59e0b;
      --panel: #0f172aee;
      --text: #e5e7eb;
      --muted: #94a3b8;
    }

    html, body { height: 100%; margin: 0; background: radial-gradient(1200px 600px at 20% 10%, #0b1220 0%, #060913 60%, #030712 100%); color: var(--text); font-family: system-ui, sans-serif; }

    header { position: fixed; top: 12px; left: 0; right: 0; display: flex; flex-direction: column; align-items: center; z-index: 5; }
    h1 { font-size: clamp(32px, 5vw, 60px); margin: 0; font-weight: 900; text-shadow: 0 4px 22px rgba(0,0,0,.45); animation: puff 1.2s ease-in-out infinite alternate; }
    p.subtitle { margin: 6px 0 0; font-size: 16px; color: var(--muted); font-weight: 500; }
    @keyframes puff { 0% { transform: scale(0.98); } 100% { transform: scale(1.06); } }

    .wheel-area { position: relative; display: grid; place-items: center; height: 100vh; }

    #wheelCanvas { width: calc(var(--wheel-radius) * 2); height: calc(var(--wheel-radius) * 2); display: block; filter: drop-shadow(0 24px 40px rgba(0,0,0,.45)); border-radius: 50%; }

    .pointer { position: absolute; left: calc(50% + var(--wheel-radius) + 12px); top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 30px solid var(--accent-orange); filter: drop-shadow(0 6px 14px rgba(0,0,0,.55)); }

    .controls { margin-top: 20px; display: flex; justify-content: center; }
    .btn { appearance: none; border: 2px solid #1f2a44; background: linear-gradient(180deg, #2563eb, #1d4ed8); color: var(--text); padding: 18px 28px; border-radius: 14px; font-weight: 800; font-size: 20px; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,.35) inset, 0 2px 8px rgba(0,0,0,.25); }
    .btn:hover { transform: translateY(-1px); }

    .editor { position: fixed; top: 50%; left: 16px; transform: translateY(-50%); width: min(420px, 36vw); background: var(--panel); backdrop-filter: blur(8px); border: 1px solid #213052; border-radius: 16px; padding: 12px; box-shadow: 0 14px 44px rgba(0,0,0,.45); z-index: 4; }
    .editor h2 { font-size: 14px; margin: 0 0 8px 0; color: var(--muted); font-weight: 700; }

    table { width: 100%; border-collapse: collapse; }
    thead th { font-size: 12px; color: var(--muted); padding: 6px 8px; text-align: left; }
    tbody td { padding: 6px 8px; }
    tbody tr { border-top: 1px dashed #22304f; }

    input[type="text"], input[type="date"] { width: 100%; box-sizing: border-box; background: #0b1222; color: var(--text); border: 1px solid #26324e; padding: 6px 8px; border-radius: 8px; }
    .color-cell { width: 56px; }
    .swatch { width: 28px; height: 20px; border-radius: 6px; border: 1px solid #233250; cursor: pointer; }
    .chance-cell { width: 84px; text-align: right; font-weight: 700; }
    .action-cell { width: 40px; text-align: right; }

    .footer-bar { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; align-items: center; background: var(--panel); padding: 12px 16px; border-radius: 12px; border: 1px solid #20304e; font-size: 18px; font-weight: 700; }

    @media (max-width: 980px) { :root { --wheel-radius: 200px; } .editor { left: 8px; width: min(92vw, 420px); } }
  </style>
</head>
<body>
  <header>
    <h1>La roue du Scribe !</h1>
    <p class="subtitle">Lance la roue et dÃ©signe l'heureux prochain scribe du V1 ! ðŸ˜ƒ</p>
  </header>

  <main class="wheel-area">
    <div class="pointer" aria-hidden="true"></div>
    <canvas id="wheelCanvas" width="800" height="800"></canvas>
    <div class="controls">
      <button id="spinBtn" class="btn">ðŸŽ¯ Lancer</button>
    </div>
  </main>

  <div class="footer-bar" id="resultBar" style="display:none">
    Le prochain scribe est : <span id="winnerName">â€”</span> !
  </div>

  <aside class="editor">
    <h2>Participants &amp; derniÃ¨res dates</h2>
    <table>
      <thead>
        <tr>
          <th>Nom</th>
          <th>Dernier passage</th>
          <th class="color-cell">Couleur</th>
          <th class="chance-cell">% chance</th>
          <th class="action-cell"></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <button id="addRowBtn" class="btn" style="margin-top:8px;">+ Ajouter</button>
  </aside>

  <script>
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const rowsTbody = document.getElementById('rows');
    const addRowBtn = document.getElementById('addRowBtn');
    const resultBar = document.getElementById('resultBar');
    const winnerNameEl = document.getElementById('winnerName');

    function getCssRadius() {
      const v = getComputedStyle(document.documentElement).getPropertyValue('--wheel-radius').trim();
      const m = v.match(/([\d.]+)px/);
      return m ? parseFloat(m[1]) : 260;
    }

    function resizeCanvasToRadius() {
      const r = getCssRadius();
      const size = r * 2;
      const dpr = window.devicePixelRatio || 1;
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      canvas.width = size * dpr;
      canvas.height = size * dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    let people = [ {name:'Alice',last:'',color:''}, {name:'BenoÃ®t',last:'',color:''} ];
    const DAY=86400000;
    function daysSince(iso){ if(!iso)return null; const d=new Date(iso+'T00:00:00'); if(isNaN(d))return null; return Math.max(0,Math.floor((Date.now()-d)/DAY)); }
    function weightFor(iso,max){ const ds=daysSince(iso); return ds===null?max+30:Math.max(1,ds); }

    let slices=[]; let rotationDeg=0;
    function rebuildSlices(){
      const vals=people.map(p=>daysSince(p.last)).filter(v=>v!==null);
      const max=vals.length?Math.max(...vals):30;
      const weights=people.map(p=>weightFor(p.last,max));
      const total=weights.reduce((a,b)=>a+b,0)||1;
      let cursor=-90;
      slices=people.map((p,i)=>{const w=weights[i];const ang=w/total*360;const start=cursor;cursor+=ang;return{name:p.name||'â€”',startDeg:start,endDeg:cursor,percent:w/total*100,color:p.color||`hsl(${i*60} 70% 50%)`};});
    }

    function drawWheel(){const r=getCssRadius();ctx.clearRect(0,0,canvas.width,canvas.height);ctx.save();ctx.translate(r,r);ctx.rotate(rotationDeg*Math.PI/180);slices.forEach(s=>{const a0=s.startDeg*Math.PI/180,a1=s.endDeg*Math.PI/180;ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,r-8,a0,a1);ctx.closePath();ctx.fillStyle=s.color;ctx.fill();});ctx.restore();}

    function inRange(a,start,end){const norm=x=>(x%360+360)%360;a=norm(a);start=norm(start);end=norm(end);if(start<end)return a>=start&&a<end;return a>=start||a<end;}
    function winnerForRotation(rot){let pointer=(0-rot)%360;if(pointer<0)pointer+=360;return slices.find(s=>inRange(pointer,s.startDeg,s.endDeg))||slices[slices.length-1];}

    function spin(){const start=performance.now(),init=rotationDeg,target=Math.random()*360,turns=6+Math.floor(Math.random()*3),delta=turns*360+target,dur=5000;function step(t){const p=Math.min(1,(t-start)/dur);const ease=1-(--p*p*p*p);rotationDeg=init+delta*ease;drawWheel();if(p<1)requestAnimationFrame(step);else{const w=winnerForRotation(rotationDeg);winnerNameEl.textContent=w.name;resultBar.style.display='flex';}}requestAnimationFrame(step);}

    function renderTable(){rowsTbody.innerHTML='';const vals=people.map(p=>daysSince(p.last)).filter(v=>v!==null);const max=vals.length?Math.max(...vals):30;const weights=people.map(p=>weightFor(p.last,max));const total=weights.reduce((a,b)=>a+b,0)||1;people.forEach((p,i)=>{const tr=document.createElement('tr');const td1=document.createElement('td');const n=document.createElement('input');n.value=p.name;n.oninput=()=>{p.name=n.value;rebuildSlices();drawWheel();renderTable();};td1.appendChild(n);const td2=document.createElement('td');const d=document.createElement('input');d.type='date';d.value=p.last;d.onchange=()=>{p.last=d.value;rebuildSlices();drawWheel();renderTable();};td2.appendChild(d);const td3=document.createElement('td');const sw=document.createElement('div');sw.className='swatch';sw.style.background=p.color||`hsl(${i*60} 70% 50%)`;const c=document.createElement('input');c.type='color';c.value='#ff0000';c.style.display='none';sw.onclick=()=>c.click();c.oninput=()=>{p.color=c.value;sw.style.background=c.value;rebuildSlices();drawWheel();};td3.appendChild(sw);td3.appendChild(c);const td4=document.createElement('td');td4.className='chance-cell';td4.textContent=(weights[i]/total*100).toFixed(1)+'%';const td5=document.createElement('td');const btn=document.createElement('button');btn.textContent='Ã—';btn.onclick=()=>{people.splice(i,1);rebuildSlices();drawWheel();renderTable();};td5.appendChild(btn);tr.append(td1,td2,td3,td4,td5);rowsTbody.appendChild(tr);});}

    addRowBtn.onclick=()=>{people.push({name:'',last:'',color:''});rebuildSlices();drawWheel();renderTable();};
    spinBtn.onclick=spin;

    resizeCanvasToRadius();
    rebuildSlices();
    drawWheel();
    renderTable();
    window.onresize=()=>{resizeCanvasToRadius();drawWheel();};
  </script>
</body>
</html>
